import os
import random
from dotenv import find_dotenv, load_dotenv
import asyncio

load_dotenv(find_dotenv())

openrouter_api_key = os.getenv("OPENROUTER_API_KEY")
openrouter_base_url = os.getenv("OPENROUTER_API_BASE_URL")
openrouter_model = os.getenv("OPENROUTER_MODEL")
browser_use_api_key = os.getenv("BROWSER_USE_API_KEY")
openai_api_key=os.getenv("OPENAI_API_KEY")

from agno.models.openrouter import OpenRouter


model = OpenRouter(
  id=openrouter_model,
  api_key=openrouter_api_key,
  base_url=openrouter_base_url,
  temperature=0.4,
  reasoning_effort="low"
)


from agno.workflow import Workflow
from agno.agent import Agent
from agno.tools.mcp import MCPTools
from agno.tools import tool
from pydantic import BaseModel, Field
from typing import List
from browser_use import Agent as BrowserUseAgent, Browser, ChatBrowserUse


class SearchResponse(BaseModel):
  title: str = Field(description="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞")
  price: float = Field(description="–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞")
  link: str = Field(description="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä")


searcher_instructions = """
–¢—ã ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `browse_web_cloud` –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö.

–í–ê–ñ–ù–û: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `browse_web_cloud` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É `task`. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –∞–≥–µ–Ω—Ç –æ—á–µ–Ω—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –µ–º—É –Ω—É–∂–Ω—ã –ß–ï–¢–ö–ò–ï –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
–¢—ã –ù–ï –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω–∞–π–¥–∏ –∫–∞—Å—Ç–µ—Ç"). –¢—ã –¥–æ–ª–∂–µ–Ω –æ–±–µ—Ä–Ω—É—Ç—å –µ–≥–æ –≤ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º.

–ö–û–ì–î–ê –¢–´ –í–´–ó–´–í–ê–ï–®–¨ `browse_web_cloud`, –ü–ê–†–ê–ú–ï–¢–† `task` –î–û–õ–ñ–ï–ù –°–û–î–ï–†–ñ–ê–¢–¨ –°–õ–ï–î–£–Æ–©–ò–ô –¢–ï–ö–°–¢ (–∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):

--- –ù–ê–ß–ê–õ–û –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ë–†–ê–£–ó–ï–†–ê ---
–¶–µ–ª—å: –ù–∞–π—Ç–∏ [–¢–û–í–ê–† –ò–ó –ó–ê–ü–†–û–°–ê] –Ω–∞ [–°–ê–ô–¢/–ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°].

–ê–õ–ì–û–†–ò–¢–ú –î–ï–ô–°–¢–í–ò–ô:
1. **–í–•–û–î –ò –ó–ê–ß–ò–°–¢–ö–ê:**
   - –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ —Å–∞–π—Ç.
   - –°—Ä–∞–∑—É –∑–∞–∫—Ä–æ–π –ª—é–±—ã–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ (Cookies, –≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞, –±–∞–Ω–Ω–µ—Ä—ã), –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

2. **–ü–û–ò–°–ö:**
   - –ù–∞–π–¥–∏ —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞, –≤–≤–µ–¥–∏ "[–¢–û–í–ê–† –ò–ó –ó–ê–ü–†–û–°–ê]", –Ω–∞–∂–º–∏ Enter.
   - –î–æ–∂–¥–∏—Å—å –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–¥–∞—á–∏.

3. **–°–û–†–¢–ò–†–û–í–ö–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):**
   - –ù–∞–π–¥–∏ –∫–Ω–æ–ø–∫—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ("–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞", "Sort", –∏–∫–æ–Ω–∫—É —Ñ–∏–ª—å—Ç—Ä–æ–≤).
   - –í—ã–±–µ—Ä–∏ "–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ" (Price: Low to High).
   - –î–æ–∂–¥–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.

4. **–°–ë–û–† –î–ê–ù–ù–´–•:**
   - –ü—Ä–æ–ø—É—Å—Ç–∏ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –±–ª–æ–∫–∏.
   - –°–æ–±–µ—Ä–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø–µ—Ä–≤—ã—Ö 10 —Ç–æ–≤–∞—Ä–∞—Ö –∏–∑ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–æ–π –≤—ã–¥–∞—á–∏.
   - –§–æ—Ä–º–∞—Ç: Title, Price (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã), Link.
--- –ö–û–ù–ï–¶ –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ë–†–ê–£–ó–ï–†–ê ---

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç `task` –∏ –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç. –ù–µ –ø—ã—Ç–∞–π—Å—è –∏—Å–∫–∞—Ç—å —Å–∞–º, –∏—Å–ø–æ–ª—å–∑—É–π —Ç—É–ª–∑.
"""

# server_params = StdioServerParameters(
#   command="uvx",
#   args=["--from", "browser-use[cli]", "browser-use", "--mcp"],
#   env={
#     **os.environ,
#     "BROWSER_USE_HEADLESS": "false" 
#   }
# )
@tool(
    name="browse_web_cloud",                # Custom name for the tool (otherwise the function name is used)
    description="Get the info in the web",  # Custom description (otherwise the function docstring is used)
    requires_confirmation=False,                     # Requires user confirmation before execution                             # Cache TTL in seconds (1 hour)
)
async def browse_web_cloud(task: str) -> str:
  """
    Get the info in the web

    Args:
        task (str): task to search info
  """
  try:          
    browser = Browser(use_cloud=False)
    llm = ChatBrowserUse(
      api_key=browser_use_api_key
    )
    agent = BrowserUseAgent(
        browser=browser,
        task=task,
        llm=llm,
    )
    data = await agent.run()
    return data.model_dump_json()

  except Exception as e:
      return f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {str(e)}"


# mcp_tools = MCPTools(transport="streamable-http", url="http://127.0.0.1:3010/mcp", timeout_seconds=240)
# await mcp_tools.connect()

browser_agent = Agent(
  name="browser agent",
  role="Navigation and Scrapping",
  instructions=searcher_instructions,
  markdown=True,
  debug_mode=True,
  structured_outputs=List[SearchResponse],
  model=model,
  tools=[browse_web_cloud]
)


validator_instructions = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–ª—É—á–∏—Ç—å "—Å—ã—Ä–æ–π" —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –æ—Ç –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –º—É—Å–æ—Ä –∏ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω–æ –ª—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
–¢—ã –ø–æ–ª—É—á–∞–µ—à—å —Ç–µ–∫—Å—Ç –∏–ª–∏ JSON, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (–ù–∞–∑–≤–∞–Ω–∏–µ, –¶–µ–Ω–∞, –°—Å—ã–ª–∫–∞).

–¢–í–û–ô –ê–õ–ì–û–†–ò–¢–ú –ê–ù–ê–õ–ò–ó–ê:

1. **–§–ò–õ–¨–¢–†–ê–¶–ò–Ø "–ú–£–°–û–†–ê" (Anti-Trash Check):**
   –¢—ã –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞–º–∏, –∞ –Ω–µ —Å–∞–º–∏–º –ø—Ä–µ–¥–º–µ—Ç–æ–º –ø–æ–∏—Å–∫–∞.
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–∫–∞–ª "–ö–∞—Å—Ç–µ—Ç" (–∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ø—Ä–µ–¥–º–µ—Ç), –ò–°–ö–õ–Æ–ß–ê–ô —Ç–æ–≤–∞—Ä—ã, –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Å–ª–æ–≤–∞:
     "–ß–µ—Ö–æ–ª", "–§—É—Ç–ª—è—Ä", "–ö–æ—Ä–æ–±–∫–∞", "–ü–æ–¥—Å—Ç–∞–≤–∫–∞", "–ö—Ä–µ–ø–ª–µ–Ω–∏–µ", "–ù–∞–∫–ª–µ–π–∫–∞", "–ó–∞–ø—á–∞—Å—Ç—å".
   - –°–º–æ—Ç—Ä–∏ –Ω–∞ —Ü–µ–Ω—É: –ï—Å–ª–∏ —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ 500-1000 —Ä—É–±, –∞ —Ç—ã –≤–∏–¥–∏—à—å –ø–æ–∑–∏—Ü–∏—é –∑–∞ 50 —Ä—É–± ‚Äî —ç—Ç–æ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 99% –∞–∫—Å–µ—Å—Å—É–∞—Ä –∏–ª–∏ –æ—à–∏–±–∫–∞. –£–¥–∞–ª–∏ —ç—Ç–æ.

2. **–ü–†–û–í–ï–†–ö–ê –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–ò (Context Check):**
   - –£—á–∏—Ç—ã–≤–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ (Wildberries/Ozon). –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã (–æ—Ä—É–∂–∏–µ) —Ç–∞–º —á–∞—Å—Ç–æ –º–∞—Å–∫–∏—Ä—É—é—Ç.
   - –ï—Å–ª–∏ –∏—â—É—Ç "–ö–∞—Å—Ç–µ—Ç", —Å—á–∏—Ç–∞–π –≤–∞–ª–∏–¥–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è: "–°—É–≤–µ–Ω–∏—Ä", "–ë—Ä–µ–ª–æ–∫", "–ú–∞—Å—Å–∞–∂–µ—Ä", "–£–ø–æ—Ä", "–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π", —Ç–∞–∫ –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–µ–µ –æ—Ä—É–∂–∏–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –Ω–µ–ª—å–∑—è.
   - –ù–µ —É–¥–∞–ª—è–π —Ç–æ–≤–∞—Ä, –µ—Å–ª–∏ –æ–Ω –Ω–∞–∑–≤–∞–Ω "–°—É–≤–µ–Ω–∏—Ä", —ç—Ç–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ.

3. **–§–ò–ù–ê–õ–¨–ù–´–ô –í–´–ë–û–†:**
   - –ò–∑ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è "—á–∏—Å—Ç–æ–≥–æ" —Å–ø–∏—Å–∫–∞ –≤—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä —Å —Å–∞–º–æ–π –Ω–∏–∑–∫–æ–π —Ü–µ–Ω–æ–π.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

üèÜ –õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
–¢–æ–≤–∞—Ä [–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ]
–¶–µ–Ω–∞: [–¶–µ–Ω–∞]
–°—Å—ã–ª–∫–∞ [URL]

### ‚ö†Ô∏è –ê–Ω–∞–ª–∏–∑ –≤—ã–±–æ—Ä–∫–∏
–ö—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —Ç—ã –≤—ã–±—Ä–∞–ª –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏ –æ—Ç—Å–µ—è–ª –æ—Å—Ç–∞–ª—å–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü–µ—Ä–≤—ã–µ 3 –ø–æ–∑–∏—Ü–∏–∏ –±—ã–ª–∏ —á–µ—Ö–ª–∞–º–∏, –ø–æ—ç—Ç–æ–º—É —è –≤—ã–±—Ä–∞–ª 4-–π –≤–∞—Ä–∏–∞–Ω—Ç").
–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Å—É–≤–µ–Ω–∏—Ä—ã/–º—É–ª—è–∂–∏, –¥–æ–±–∞–≤—å –¥–∏—Å–∫–ª–µ–π–º–µ—Ä: "–ù–∞—Å—Ç–æ—è—â–µ–µ —Ö–æ–ª–æ–¥–Ω–æ–µ –æ—Ä—É–∂–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∫ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö, –Ω–∞–π–¥–µ–Ω –Ω–∞–∏–±–æ–ª–µ–µ –±–ª–∏–∑–∫–∏–π —Å—É–≤–µ–Ω–∏—Ä–Ω—ã–π –∞–Ω–∞–ª–æ–≥".

–ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –Ω–∞–ø–∏—à–∏: "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä —Å—Ä–µ–¥–∏ –¥–µ—à–µ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π."
"""


validator_agent = Agent(
    name="product_validator",
    role="Product and Price Analyst",
    model=model,
    instructions=validator_instructions,
    markdown=True,
)

workflow = Workflow(
  name="Product Search Pipeline",
  steps=[
    browser_agent,
    validator_agent
  ],
  stream=True
)
async def run_task(): 
  await workflow.aprint_response("–ù–∞–π–¥–∏ —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π –∫–∞—Å—Ç–µ—Ç –¥–ª—è —Å–∞–º–æ–æ–±–æ—Ä–æ–Ω—ã –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç–µ", stream=True, show_step_details=True)
  
asyncio.run(run_task())
   